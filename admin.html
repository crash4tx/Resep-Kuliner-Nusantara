<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Resep Nusantara</title>
  <link rel="stylesheet" href="/css/admin.css" />
</head>

<body>

  <!-- ================= TOP BAR ================= -->
  <header class="topbar">
    <h1>Admin Dashboard</h1>
    <div class="top-actions">
      <span class="admin-badge">ADMIN</span>
    </div>
  </header>

  <!-- ================= STATS ================= -->
  <section class="stats">
    <div class="stat-card">
      <p>Provinsi</p>
      <h2 id="statProv">–</h2>
      <span>Total provinsi</span>
    </div>

    <div class="stat-card">
      <p>Resep</p>
      <h2 id="statRecipe">–</h2>
      <span>Total resep</span>
    </div>

    <div class="stat-card">
      <p>Publikasi</p>
      <h2>Aktif</h2>
      <span class="green">Online</span>
    </div>

    <div class="stat-card">
      <p>Status</p>
      <h2>Stabil</h2>
      <span class="green">Normal</span>
    </div>
  </section>

  <!-- ================= PROVINSI ================= -->
  <section class="card">
    <h2>Tambah / Edit Provinsi</h2>

    <div class="form-grid">
      <input id="prov-name" placeholder="Nama Provinsi" />
      <input id="prov-slug" placeholder="Slug (contoh: di-yogyakarta)" />
      <input type="file" id="prov-img" />
    </div>

    <button id="addProv" class="btn-primary">Simpan Provinsi</button>
  </section>

  <section class="card">
    <h3>Daftar Provinsi</h3>
    <div id="provList" class="list"></div>
  </section>

  <!-- ================= RESEP ================= -->
  <section class="card">
    <h2>Tambah / Edit Resep</h2>

    <select id="recipe-prov"></select>

    <div class="form-grid">
      <input id="rec-title" placeholder="Nama Resep" />
      <input id="rec-slug" placeholder="Slug Resep" />
    </div>

    <textarea id="rec-teaser" placeholder="Teaser singkat (homepage)"></textarea>
    <textarea id="rec-desc" placeholder="Deskripsi Lengkap"></textarea>
    <textarea id="rec-ing" placeholder="Bahan (pisahkan koma)"></textarea>
    <textarea id="rec-step" placeholder="Langkah (pisahkan titik)"></textarea>

    <input type="file" id="rec-img" />

    <button id="addRecipe" class="btn-primary">Simpan Resep</button>
  </section>

  <section class="card">
    <h3>Daftar Resep</h3>
    <div id="recipeList" class="list"></div>
  </section>

  <!-- ================= SCRIPT (TIDAK DIUBAH LOGIKA) ================= -->
  <script type="module">
    import { supabase } from "/js/supabase.js";

    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
      alert("Login dulu");
      location.href = "login.html";
      throw "NO USER";
    }

    const { data: profile } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

    if (!profile || profile.role !== "admin") {
      document.body.innerHTML = "<h2>Akses ditolak</h2>";
      throw "NOT ADMIN";
    }

    const provList = document.getElementById("provList");
    const recipeList = document.getElementById("recipeList");
    const provSelect = document.getElementById("recipe-prov");

    const provName = document.getElementById("prov-name");
    const provSlug = document.getElementById("prov-slug");
    const provImg = document.getElementById("prov-img");
    const provBtn = document.getElementById("addProv");

    const recTitle = document.getElementById("rec-title");
    const recSlug = document.getElementById("rec-slug");
    const recTeaser = document.getElementById("rec-teaser");
    const recDesc = document.getElementById("rec-desc");
    const recIng = document.getElementById("rec-ing");
    const recStep = document.getElementById("rec-step");
    const recImg = document.getElementById("rec-img");
    const recBtn = document.getElementById("addRecipe");

    async function loadProvinces() {
      provList.innerHTML = "";
      provSelect.innerHTML = "";

      const { data } = await supabase.from("provinces").select("*").order("name");

      document.getElementById("statProv").innerText = data.length;

      data.forEach((p) => {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <span><b>${p.name}</b> (${p.slug})</span>
          <div>
            <button data-id="${p.id}" class="edit">Edit</button>
            <button data-id="${p.id}" class="delete">Hapus</button>
          </div>
        `;
        provList.appendChild(div);

        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        provSelect.appendChild(opt);
      });
    }

    async function loadRecipes() {
      recipeList.innerHTML = "";
      const { data } = await supabase.from("recipes").select("*").order("title");

      document.getElementById("statRecipe").innerText = data.length;

      data.forEach((r) => {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <span><b>${r.title}</b></span>
          <div>
            <button data-id="${r.id}" class="edit-rec">Edit</button>
            <button data-id="${r.id}" class="delete-rec">Hapus</button>
          </div>
        `;
        recipeList.appendChild(div);
      });
    }

    await loadProvinces();
    await loadRecipes();
  </script>

</body>
</html>
