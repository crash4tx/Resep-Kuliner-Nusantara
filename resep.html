<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTitle">Resep ‚Äì Resep Nusantara</title>

    <link rel="stylesheet" href="/public/css/resep_masakan.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar">
      <div class="logo">
        <img src="/public/img/ikon/vector.svg" />
        <span>ResepNusantara</span>
      </div>

      <ul class="menu">
        <li><a href="/public/beranda.html">Beranda</a></li>
        <li><a href="/public/provinsi.html" class="active">Provinsi</a></li>
        <li><a href="/public/peringkat.html">Peringkat</a></li>
      </ul>
    </nav>

    <!-- HERO -->
    <section class="hero">
      <img id="heroImg" class="hero-img" />

      <div class="hero-content">
        <a href="javascript:history.back()" class="btn-back">‚Üê Kembali</a>

        <span class="badge-provinsi" id="provinsi"></span>
        <h1 id="judul"></h1>

        <div class="rating-wrapper">
          <button class="rate-btn" id="likeBtn">
            üëç <span id="likeCount">0</span>
          </button>
          <button class="rate-btn" id="dislikeBtn">
            üëé <span id="dislikeCount">0</span>
          </button>
        </div>
      </div>
    </section>

    <!-- DESKRIPSI -->
    <section class="section">
      <h2>Tentang Menu Ini</h2>
      <p class="sub" id="deskripsi"></p>
    </section>

    <!-- DETAIL -->
    <div class="detail-container">
      <div class="detail-card">
        <h3>Resep</h3>
        <ul id="bahan"></ul>
      </div>

      <div class="detail-card">
        <h3>Cara Mengolah</h3>
        <ul id="langkah"></ul>
      </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const supabase = createClient(
        "https://sgjahqdlynjxjnuuclbt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnamFocWRseW5qeGpudXVjbGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNjg1OTEsImV4cCI6MjA4MTc0NDU5MX0.TFUVBz0hx1FJPpB6sydVszx9HL0iQXQZDdEvy6POhh4"
      );

      const slug = new URLSearchParams(location.search).get("slug");

      /* ================= LOAD USER ================= */
      const {
        data: { user },
      } = await supabase.auth.getUser();

      /* ================= LOAD RECIPE ================= */
      const { data: recipe } = await supabase
        .from("recipes")
        .select("*")
        .eq("slug", slug)
        .maybeSingle();

      if (!recipe) {
        document.body.innerHTML =
          "<p style='padding:40px'>Resep tidak ditemukan</p>";
        throw new Error("Recipe not found");
      }

      /* ================= LOAD PROVINCE ================= */
      const { data: province } = await supabase
        .from("provinces")
        .select("name")
        .eq("id", recipe.province_id)
        .single();

      /* ================= RENDER ================= */
      document.getElementById("judul").innerText = recipe.title;
      document.getElementById("heroImg").src = recipe.image_url;
      document.getElementById("provinsi").innerText = province?.name || "";
      document.getElementById("deskripsi").innerText = recipe.description;
      document.getElementById(
        "pageTitle"
      ).innerText = `${recipe.title} ‚Äì Resep Nusantara`;

      recipe.ingredients.split(",").forEach((i) => {
        const li = document.createElement("li");
        li.textContent = i.trim();
        document.getElementById("bahan").appendChild(li);
      });

      recipe.steps.split(".").forEach((s) => {
        if (s.trim()) {
          const li = document.createElement("li");
          li.textContent = s.trim();
          document.getElementById("langkah").appendChild(li);
        }
      });

      /* ================= LOAD COUNTS ================= */
      const loadCounts = async () => {
        const { count: likeCount } = await supabase
          .from("recipe_votes")
          .select("*", { count: "exact", head: true })
          .eq("recipe_id", recipe.id)
          .eq("vote", "like");

        const { count: dislikeCount } = await supabase
          .from("recipe_votes")
          .select("*", { count: "exact", head: true })
          .eq("recipe_id", recipe.id)
          .eq("vote", "dislike");

        document.getElementById("likeCount").innerText = likeCount ?? 0;
        document.getElementById("dislikeCount").innerText = dislikeCount ?? 0;
      };

      await loadCounts();

      /* ================= LOAD USER VOTE ================= */
      const { data: myVote } = user
        ? await supabase
            .from("recipe_votes")
            .select("vote")
            .eq("recipe_id", recipe.id)
            .eq("user_id", user.id)
            .maybeSingle()
        : { data: null };

      const likeBtn = document.getElementById("likeBtn");
      const dislikeBtn = document.getElementById("dislikeBtn");

      if (myVote?.vote === "like") likeBtn.classList.add("active");
      if (myVote?.vote === "dislike") dislikeBtn.classList.add("active");

      /* ================= HANDLE VOTE ================= */
      const vote = async (type) => {
        if (!user) {
          alert("Login dulu untuk memberi vote");
          return;
        }

        const { data: existing } = await supabase
          .from("recipe_votes")
          .select("*")
          .eq("recipe_id", recipe.id)
          .eq("user_id", user.id)
          .maybeSingle();

        if (!existing) {
          await supabase.from("recipe_votes").insert({
            recipe_id: recipe.id,
            user_id: user.id,
            vote: type,
          });
        } else if (existing.vote === type) {
          await supabase.from("recipe_votes").delete().eq("id", existing.id);
        } else {
          await supabase
            .from("recipe_votes")
            .update({ vote: type })
            .eq("id", existing.id);
        }

        location.reload();
      };

      likeBtn.onclick = () => vote("like");
      dislikeBtn.onclick = () => vote("dislike");
    </script>
  </body>
</html>
